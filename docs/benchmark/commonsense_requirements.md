# Commonsense Benchmark - 功能需求文档

## 1. 项目概述

本项目旨在为 LLaMA-Factory-KT 提供一套完整的 commonsense reasoning（常识推理）多数据集、单 adapter LoRA 微调方案。

## 2. 需求背景

### 2.1 业务背景
- 常识推理是评估大语言模型理解能力的重要指标
- 需要使用多个标准 benchmark 数据集进行训练和评估
- 支持多种 MoE 模型架构（DeepSeek-V2/V3、Qwen3-MoE）
- 需要同时支持标准训练和 KTransformers（KT）加速训练

### 2.2 用户场景
- 研究人员需要评估模型的常识推理能力
- 需要在有限 GPU 资源下使用 KT 后端训练大型 MoE 模型
- 需要使用验证集监控训练过程中的模型性能

## 3. 功能需求

### 3.1 数据集支持

| 需求ID | 需求描述 | 优先级 |
|--------|----------|--------|
| FR-001 | 支持 ARC-Challenge 数据集 | P0 |
| FR-002 | 支持 ARC-Easy 数据集 | P0 |
| FR-003 | 支持 BoolQ 数据集 | P0 |
| FR-004 | 支持 HellaSwag 数据集 | P0 |
| FR-005 | 支持 OpenBookQA 数据集 | P0 |
| FR-006 | 支持 PIQA 数据集 | P0 |
| FR-007 | 支持 Social IQA 数据集 | P0 |
| FR-008 | 支持 Winogrande 数据集 | P0 |
| FR-009 | 数据集自动转换为 alpaca 格式 | P0 |
| FR-010 | 支持训练集和验证集分离 | P0 |

### 3.2 模型支持

| 需求ID | 需求描述 | 优先级 |
|--------|----------|--------|
| FR-011 | 支持 DeepSeek-V2-Lite 模型 | P0 |
| FR-012 | 支持 DeepSeek-V3 模型 | P0 |
| FR-013 | 支持 Qwen3-30B-A3B MoE 模型 | P0 |
| FR-014 | 每个模型支持 KT 和非 KT 两种训练模式 | P0 |

### 3.3 训练功能

| 需求ID | 需求描述 | 优先级 |
|--------|----------|--------|
| FR-015 | 支持多数据集合并训练（单 adapter） | P0 |
| FR-016 | 支持 LoRA 微调 | P0 |
| FR-017 | 支持验证集评估（eval loss） | P0 |
| FR-018 | 支持训练过程可视化（loss plot） | P1 |
| FR-019 | 支持断点续训 | P1 |

### 3.4 KTransformers 支持

| 需求ID | 需求描述 | 优先级 |
|--------|----------|--------|
| FR-020 | KT 模式支持 AMX BF16 后端 | P0 |
| FR-021 | KT 模式支持 CPU 线程配置 | P0 |
| FR-022 | KT 模式支持验证集评估 | P0 |
| FR-023 | KT 模式禁用 gradient checkpointing | P0 |

## 4. 非功能需求

### 4.1 性能需求

| 需求ID | 需求描述 | 优先级 |
|--------|----------|--------|
| NFR-001 | 数据转换脚本在 5 分钟内完成 | P1 |
| NFR-002 | KT 训练相比标准训练显存降低 50%+ | P1 |

### 4.2 可维护性需求

| 需求ID | 需求描述 | 优先级 |
|--------|----------|--------|
| NFR-003 | 提供完整的配置文档 | P0 |
| NFR-004 | YAML 配置文件注释清晰 | P0 |
| NFR-005 | 数据转换脚本可复用 | P1 |

## 5. 数据集统计

| 数据集 | 训练集 | 验证集 | 任务类型 |
|--------|--------|--------|----------|
| ARC-Challenge | 1,119 | 299 | 多选题 |
| ARC-Easy | 2,251 | 570 | 多选题 |
| BoolQ | 9,427 | 3,270 | 是非题 |
| HellaSwag | 39,905 | 10,042 | 句子续写 |
| OpenBookQA | 4,957 | 500 | 多选题 |
| PIQA | 16,113 | 1,838 | 物理常识 |
| Social IQA | 33,410 | 1,954 | 社交推理 |
| Winogrande | 40,398 | 1,267 | 指代消歧 |
| **总计** | **147,580** | **19,740** | - |

## 6. 约束条件

### 6.1 技术约束
- KT 模式不支持 `predict_with_generate` 功能
- KT 模式不支持 `compute_accuracy` 功能
- KT 模式验证只能使用 eval loss 指标

### 6.2 资源约束
- 模型路径依赖特定服务器环境
- KT 训练需要 Intel AMX 指令集支持

## 7. 验收标准

1. 所有 8 个数据集成功转换为 alpaca 格式
2. 数据集正确注册到 dataset_info.json
3. 6 个 YAML 配置文件可正常加载
4. 训练脚本可正常启动并开始训练
5. 验证集评估在训练过程中正常执行
